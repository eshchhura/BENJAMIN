<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>BENJAMIN Command Center</title>
    <link rel="stylesheet" href="/ui/static/app.css" />
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  </head>
  <body>
    <header>
      <h1>BENJAMIN Command Center</h1>
      <nav>
        <a href="/ui/chat">Chat</a>
        <a href="/ui/approvals">Approvals</a>
        <a href="/ui/jobs">Jobs</a>
        <a href="/ui/rules">Rules</a>
        <a href="/ui/memory">Memory</a>
        <a href="/ui/runs">Runs</a>
        <a href="/ui/scopes">Scopes</a>
        <a href="/ui/doctor">Doctor</a>
        <form method="post" action="/ui/logout" style="display:inline-block;margin-left:1rem;">
          <button type="submit">Logout</button>
        </form>
      </nav>
    </header>
    <div id="breaker-banner" style="display:none;padding:0.75rem 1rem;background:#fff4e5;border:1px solid #f59e0b;margin:1rem;color:#7c2d12;font-weight:600;"></div>
    {% if safe_mode_enabled %}
    <div style="padding:0.9rem 1rem;background:#fee2e2;border:1px solid #dc2626;margin:1rem;color:#7f1d1d;font-weight:700;">SAFE MODE ENABLED: write actions and approvals are disabled.</div>
    {% endif %}
    <main>
      {% block content %}{% endblock %}
    </main>
    <script>
      async function refreshBreakerBanner() {
        try {
          const response = await fetch("/integrations/status", { credentials: "same-origin" });
          if (!response.ok) {
            return;
          }
          const payload = await response.json();
          const breakers = payload.breakers || {};
          const degraded = Object.entries(breakers)
            .filter(([, data]) => data && data.state === "open")
            .map(([name]) => `${name} (open)`);
          const banner = document.getElementById("breaker-banner");
          if (!banner) {
            return;
          }
          if (degraded.length === 0) {
            banner.style.display = "none";
            banner.textContent = "";
            return;
          }
          banner.style.display = "block";
          banner.textContent = `Degraded services: ${degraded.join(", ")}. See /integrations/status`;
        } catch (_error) {
          // no-op
        }
      }
      refreshBreakerBanner();

      document.body.addEventListener("htmx:configRequest", function (event) {
        const tokenCookie = document.cookie
          .split(";")
          .map((value) => value.trim())
          .find((value) => value.startsWith("benjamin_token="));
        if (!tokenCookie) {
          return;
        }
        const token = decodeURIComponent(tokenCookie.split("=").slice(1).join("="));
        if (token) {
          event.detail.headers["X-BENJAMIN-TOKEN"] = token;
        }
      });
    </script>
  </body>
</html>
