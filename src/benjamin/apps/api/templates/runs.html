{% extends "base.html" %}
{% block content %}
<h2>Run History</h2>

<form method="get" action="/ui/runs" style="display:flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
  <label>
    Kind
    <select name="kind">
      {% for value in ["all", "chat", "rule", "job", "approval", "policy"] %}
      <option value="{{ value }}" {% if kind == value %}selected{% endif %}>{{ value }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Status
    <select name="status">
      {% for value in ["all", "ok", "failed", "skipped"] %}
      <option value="{{ value }}" {% if status == value %}selected{% endif %}>{{ value }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    Search
    <input type="text" name="q" value="{{ q }}" placeholder="task id, correlation, summary"/>
  </label>
  <label>
    Limit
    <input type="number" min="1" max="200" name="limit" value="{{ limit }}"/>
  </label>
  <button type="submit">Apply filters</button>
</form>

<section>
  <h3>Recent Chats</h3>
  {% if tasks %}
    <ul>
      {% for task in tasks %}
      <li>
        <a href="/ui/runs/chat/{{ task.task_id }}">{{ task.task_id }}</a>
        — {{ task.ts_iso }} — {{ task.user_message }}
        {% if task.correlation_id %}
        — correlation: <a href="/ui/correlation/{{ task.correlation_id }}">{{ task.correlation_id }}</a>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No chat runs.</p>
  {% endif %}
</section>

<section>
  <h3>Recent Rule Runs</h3>
  {% if rule_runs %}
    <ul>
      {% for run in rule_runs %}
      <li>
        {% if run.meta.get("rule_id") %}
        <a href="/ui/runs/rules/{{ run.meta.get('rule_id') }}">{{ run.meta.get("rule_id") }}</a>
        {% else %}
        (unknown rule)
        {% endif %}
        — {{ run.ts_iso }} — {{ run.summary }}
        {% if run.meta.get("correlation_id") %}
        — correlation: <a href="/ui/correlation/{{ run.meta.get('correlation_id') }}">{{ run.meta.get("correlation_id") }}</a>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No rule runs.</p>
  {% endif %}
</section>

<section>
  <h3>Recent Job Runs</h3>
  {% if job_runs %}
    <ul>
      {% for run in job_runs %}
      <li>
        {{ run.ts_iso }} — {{ run.kind }} — {{ run.summary }}
        {% if run.meta.get("correlation_id") %}
        — correlation: <a href="/ui/correlation/{{ run.meta.get('correlation_id') }}">{{ run.meta.get("correlation_id") }}</a>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No job runs.</p>
  {% endif %}
</section>

<section>
  <h3>Recent Approval Audits</h3>
  {% if approval_audits %}
    <ul>
      {% for run in approval_audits %}
      <li>
        {% if run.meta.get("approval_id") %}
          <a href="/ui/runs/approvals/{{ run.meta.get('approval_id') }}">{{ run.meta.get("approval_id") }}</a>
        {% else %}
          (no approval id)
        {% endif %}
        — {{ run.ts_iso }} — {{ run.summary }}
        {% if run.meta.get("correlation_id") %}
        — correlation: <a href="/ui/correlation/{{ run.meta.get('correlation_id') }}">{{ run.meta.get("correlation_id") }}</a>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No approval audit runs.</p>
  {% endif %}
</section>


<section>
  <h3>Policy Audits</h3>
  {% if policy_audits %}
    <ul>
      {% for run in policy_audits %}
      <li>
        {{ run.ts_iso }} — {{ run.summary }}
        {% if run.meta.get("correlation_id") %}
        — correlation: <a href="/ui/correlation/{{ run.meta.get('correlation_id') }}">{{ run.meta.get("correlation_id") }}</a>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No policy audit runs.</p>
  {% endif %}
</section>

<section>
  <h3>Ledger Records</h3>
  {% if ledger_records %}
  <ul>
    {% for record in ledger_records %}
    <li>
      {{ record.ts_iso }} — {{ record.kind }} — {{ record.status }} — {{ record.key }}
      {% if record.correlation_id %}
      — correlation: <a href="/ui/correlation/{{ record.correlation_id }}">{{ record.correlation_id }}</a>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No ledger records.</p>
  {% endif %}
</section>

<section>
  <h3>Approvals</h3>
  {% if approvals %}
  <ul>
    {% for approval in approvals %}
    <li>
      <a href="/ui/runs/approvals/{{ approval.id }}">{{ approval.id }}</a> — {{ approval.status }}
      {% if approval.requester.get("correlation_id") %}
      — correlation: <a href="/ui/correlation/{{ approval.requester.get('correlation_id') }}">{{ approval.requester.get("correlation_id") }}</a>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No approvals.</p>
  {% endif %}
</section>
{% endblock %}
