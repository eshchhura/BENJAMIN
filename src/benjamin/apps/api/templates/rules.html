{% extends "base.html" %}
{% block content %}
<h2>Rules</h2>
<form method="post" action="/ui/rules/evaluate-now">
  <button type="submit">Evaluate now</button>
</form>
<table>
  <tr><th>Name</th><th>Trigger</th><th>Enabled</th><th>Last run</th><th>Cooldown</th><th>Actions</th></tr>
  {% for rule in rules %}
  <tr>
    <td>{{ rule.name }}</td><td>{{ rule.trigger.type }}</td><td>{{ rule.enabled }}</td><td>{{ rule.state.last_run_iso }}</td><td>{{ rule.state.cooldown_until_iso }}</td>
    <td>
      {% if rule.enabled %}
        <form method="post" action="/ui/rules/{{ rule.id }}/disable"><button type="submit">Disable</button></form>
      {% else %}
        <form method="post" action="/ui/rules/{{ rule.id }}/enable"><button type="submit">Enable</button></form>
      {% endif %}
      <form method="post" action="/ui/rules/{{ rule.id }}/reset-state"><button type="submit">Reset</button></form>
      <form method="post" action="/ui/rules/{{ rule.id }}/delete"><button type="submit">Delete</button></form>
      <button hx-post="/rules/{{ rule.id }}/test" hx-target="#test-result-{{ rule.id }}" hx-swap="innerHTML" type="button">Test</button>
    </td>
  </tr>
  <tr>
    <td colspan="6">
      <div id="test-result-{{ rule.id }}"></div>
    </td>
  </tr>
  {% endfor %}
</table>
<h3>Build rule from text (preview)</h3>
<form method="post" action="/rules/from-text" hx-post="/rules/from-text" hx-target="#rule-preview" hx-swap="innerHTML">
  <textarea name="text" placeholder="Describe a rule..." rows="3" cols="80"></textarea>
  <button type="submit">Generate preview</button>
</form>
<pre id="rule-preview"></pre>

<h3>Create rule</h3>
<form method="post" action="/ui/rules/create" id="create-rule-form">
  <input name="name" placeholder="Rule name" />
  <select name="trigger_type">
    <option value="schedule">schedule</option>
    <option value="gmail">gmail</option>
    <option value="calendar">calendar</option>
  </select>
  <input name="contains" placeholder="contains" />
  <input name="cooldown_minutes" type="number" value="0" min="0" placeholder="cooldown minutes" />
  <input name="max_actions_per_run" type="number" value="3" min="1" placeholder="max actions per run" />
  <input name="action_title" placeholder="Notification title" />
  <input name="action_body_template" value="Matched {{count}} top={{top1}} at {{now_iso}}" />
  <button type="submit">Create</button>
  <button
    type="button"
    hx-post="/rules/test"
    hx-include="#create-rule-form"
    hx-target="#test-draft-result"
    hx-swap="innerHTML"
  >
    Test Draft
  </button>
</form>
<div id="test-draft-result"></div>
{% if results %}
<h3>Latest results</h3>
<ul>{% for item in results %}<li>{{ item.rule_id }} matched={{ item.matched }} ok={{ item.ok }} notes={{ item.notes }}</li>{% endfor %}</ul>
{% endif %}
{% endblock %}
